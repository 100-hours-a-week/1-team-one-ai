name: AI (FastAPI) CI/CD

on:
  pull_request:
    types: [opened, synchronize, closed]
    branches: [develop, main]

jobs:
  # =========================================================
  # CI Job: ì½”ë“œ ê²€ì‚¬, í…ŒìŠ¤íŠ¸, ì†ŒìŠ¤ ì½”ë“œ ì••ì¶•(Artifact ìƒì„±)
  # =========================================================
  ci:
    if: github.event.action == 'opened' || github.event.action == 'synchronize'
    runs-on: ubuntu-latest
    steps:
      # 1. ì½”ë“œ ì²´í¬ì•„ì›ƒ
      - name: Checkout Code
        uses: actions/checkout@v4

      # 2. Python í™˜ê²½ ì„¤ì • (3.11)
      - name: Setup Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          
      # 3. uv ì„¤ì¹˜
      - name: Install uv
        run: curl -LsSf https://astral.sh/uv/install.sh | sh

      # 4. ì˜ì¡´ì„± ì„¤ì¹˜ (CIìš© - CPU PyTorch)
      # CPU ë²„ì „ìœ¼ë¡œ ì„¤ì¹˜
      - name: Install Dependencies
        run: |
          uv pip install --system \
            --index-url https://download.pytorch.org/whl/cpu \
            --extra-index-url https://pypi.org/simple \
            -r requirements.txt
          uv pip install --system ruff pytest httpx

      # Phase 1: Lint (Ruff)
      - name: Run Linter (Ruff)
        run: ruff check . --fix
        continue-on-error: true # ì´ˆê¸°ì—” ê²½ê³ ë§Œ (ì ì§„ì  ê°œì„ )

      # Phase 2: Test (TODO: í…ŒìŠ¤íŠ¸ ì‘ì„± í›„ í™œì„±í™”)
      - name: Run Tests
        run: pytest

      # Phase 3: Artifact Build (ì†ŒìŠ¤ ì½”ë“œ ì••ì¶•)
      # .git, __pycache__, .venv ë“± ë¶ˆí•„ìš”í•œ íŒŒì¼ ì œì™¸
      - name: Zip Source Code
        run: |
          mkdir build
          zip -r build/ai-app.zip . -x "*.git*" ".github*" ".venv*" "__pycache__*" "tests*" "notebooks*"

      # Phase 4: Artifact Upload
      - name: Upload Zip Artifact
        uses: actions/upload-artifact@v4
        with:
          name: ai-app-${{ github.sha }}
          path: build/ai-app.zip
          retention-days: 14

      #  í˜„ì¬ ì‹œê°„ êµ¬í•˜ê¸° (KST)
      - name: Get Current Time
        uses: 1466587594/get-current-time@v2
        id: current-time
        with:
          format: 'YYYY-MM-DD HH:mm:ss'
          utcOffset: "+09:00" # í•œêµ­ ì‹œê°„
          timezone: 'Asia/Seoul'

      # Phase 5: Discord ì„±ê³µ ì•Œë¦¼
      - name: Discord Notification - Success
        if: success()
        env:
          DISCORD_WEBHOOK: ${{ secrets.DISCORD_WEBHOOK_URL }}
          DISCORD_EMBEDS: |
            [{
              "title": "âœ… AI CI ì„±ê³µ",
              "color": 5763719,
              "fields": [
                {"name": "ğŸ“ Repository", "value": "${{ github.repository }}", "inline": false},
                {"name": "ğŸª„ Merge To", "value": "${{ github.base_ref }}", "inline": true},
                {"name": "ğŸ‘¤ Triggered By", "value": "**${{ github.actor }}**", "inline": true},
                {"name": "ğŸ“ Commit/PR", "value": "${{ github.event.pull_request.title }}", "inline": false},
                {"name": "ğŸ”— Actions Log", "value": "[Link to Action](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})", "inline": true}
              ],
              "footer": {
                "text": "Build #${{ github.run_number }} â€¢ ${{ steps.current-time.outputs.formattedTime }} KST",
              }
            }]
        uses: Ilshidur/action-discord@0.4.0
        with:
          args: 'CI íŒŒì´í”„ë¼ì¸ì´ ì„±ê³µì ìœ¼ë¡œ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤. <@${{ secrets.DISCORD_MENTION_USER_ID_3 }}>'

      # Phase 5: Discord ì‹¤íŒ¨ ì•Œë¦¼
      - name: Discord Notification - Failure
        if: failure()
        env:
          DISCORD_WEBHOOK: ${{ secrets.DISCORD_WEBHOOK_URL }}
          DISCORD_EMBEDS: |
            [{
              "title": "ğŸš¨ AI CI ì‹¤íŒ¨",
              "color": 15548997,
              "fields": [
                {"name": "ğŸ“ Repository", "value": "${{ github.repository }}", "inline": false},
                {"name": "ğŸª„ Merge To", "value": "${{ github.base_ref }}", "inline": true},
                {"name": "ğŸ‘¤ Triggered By", "value": "**${{ github.actor }}**", "inline": true},
                {"name": "ğŸ“ Commit/PR", "value": "${{ github.event.pull_request.title }}", "inline": false},
                {"name": "ğŸ”— Actions Log", "value": "[Link to Action](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})", "inline": true}
              ],
              "footer": {
                "text": "Build #${{ github.run_number }} â€¢ ${{ steps.current-time.outputs.formattedTime }} KST",
              }
            }]
        uses: Ilshidur/action-discord@0.4.0
        with:
          args: 'CI íŒŒì´í”„ë¼ì¸ ì‹¤í–‰ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ë¡œê·¸ë¥¼ í™•ì¸í•´ì£¼ì„¸ìš”. <@${{ secrets.DISCORD_MENTION_USER_ID }}> <@${{ secrets.DISCORD_MENTION_USER_ID_2 }}> <@${{ secrets.DISCORD_MENTION_USER_ID_3 }}>'
 
  # =========================================================
  # CD Job: ë³‘í•© ì‹œ ë°°í¬
  # =========================================================
  cd:
    if: github.event.pull_request.merged == true
    # needs: ci
    runs-on: ubuntu-latest

    permissions:
      contents: write      # Git Tag ìƒì„± ë° Pushë¥¼ ìœ„í•´ í•„ìˆ˜
      actions: read        # Artifact ë‹¤ìš´ë¡œë“œë¥¼ ìœ„í•´ í•„ìˆ˜
      pull-requests: read  # PR ì •ë³´ë¥¼ ì½ê¸° ìœ„í•´ í•„ìˆ˜

    steps:
      # 1. íƒœê¹…ìš© ì²´í¬ì•„ì›ƒ
      - name: Checkout Code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # 2. Artifact Download (CIì—ì„œ ë§Œë“  zip íŒŒì¼ ë‹¤ìš´ë¡œë“œ)
      - name: Download Zip artifact
        uses: dawidd6/action-download-artifact@v6
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          workflow: ai-ci-cd.yml    # í˜„ì¬ íŒŒì¼ëª…
          pr: ${{ github.event.pull_request.number }}
          workflow_conclusion: success
          name_is_regexp: true
          name: "ai-app-.*"
          path: ./artifacts

      # 3. íƒ€ì„ìŠ¤íƒ¬í”„ë¡œ íŒŒì¼ëª… ë³€ê²½
      - name: Prepare Zip with timestamp
        run: |
          TIMESTAMP=$(date +%Y%m%d%H%M%S)
          cd artifacts
          cd $(ls -d ai-app-* | head -n 1)
          ZIP_FILE=$(ls *.zip | head -n 1)
          mv $ZIP_FILE ../../ai-app-${TIMESTAMP}.zip
          cd ../..
          echo "ZIP_FILENAME=ai-app-${TIMESTAMP}.zip" >> $GITHUB_ENV
          echo "DEPLOY_TIMESTAMP=$TIMESTAMP" >> $GITHUB_ENV

      # 4. ì„œë²„ë¡œ ì „ì†¡ (SCP)
      - name: Transfer Zip to Server
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ github.base_ref == 'main' && secrets.PROD_SERVER_HOST || secrets.DEV_SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          port: 22
          source: "ai-app-${{ env.DEPLOY_TIMESTAMP }}.zip" # ì „ì†¡í•  íŒŒì¼
          target: "~/ai/release/"
          strip_components: 0

      # 5. ë°°í¬ ì‹¤í–‰ (SSH)
      - name: Deploy via SSH
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ github.base_ref == 'main' && secrets.PROD_SERVER_HOST || secrets.DEV_SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          port: 22
          script: |
            set -e

            PROJECT_DIR="/home/ubuntu/ai"
            RELEASE_DIR="$PROJECT_DIR/release"
            NEW_RELEASE_DIR="$RELEASE_DIR/${{ env.DEPLOY_TIMESTAMP }}"
            ZIP_FILE="$RELEASE_DIR/ai-app-${{ env.DEPLOY_TIMESTAMP }}.zip"
            CURRENT_LINK="$PROJECT_DIR/current"
            
            echo "1. ì••ì¶• í•´ì œ"
            mkdir -p $NEW_RELEASE_DIR
            unzip -q $ZIP_FILE -d $NEW_RELEASE_DIR
            
            echo "2. ì˜ì¡´ì„± ì—…ë°ì´íŠ¸ (ì„œë²„ í™˜ê²½ì— ë§ê²Œ ì„¤ì¹˜)"
            # ì„œë²„ì—ëŠ” ë¯¸ë¦¬ venvê°€ ë§Œë“¤ì–´ì ¸ ìˆë‹¤ê³  ê°€ì • (/home/ubuntu/ai/venv)
            source $PROJECT_DIR/venv/bin/activate
            
            # uvë¥¼ ì‚¬ìš©í•˜ì—¬ ì„¤ì¹˜ (ì„œë²„ì—ë„ uv ì„¤ì¹˜)
            # ì—¬ê¸°ì„œëŠ” ìš´ì˜ í™˜ê²½ì´ë¯€ë¡œ GPU ë²„ì „ì„ ì„¤ì¹˜í•´ì•¼ í•œë‹¤ë©´ requirements.txt ì„¤ì • ë”°ë¦„
            # ë˜ëŠ” --index-url ì˜µì…˜ ì œê±°
            python3.11 -m pip install uv # í˜¹ì‹œ ì—†ìœ¼ë©´ ì„¤ì¹˜
            # python3.11 -m uv pip install -r $NEW_RELEASE_DIR/requirements.txt
            # cpu ë²„ì „ìœ¼ë¡œ ì„¤ì¹˜
            python3.11 -m uv pip install --index-url https://download.pytorch.org/whl/cpu -r $NEW_RELEASE_DIR/requirements.txt
            echo "3. ì‹¬ë³¼ë¦­ ë§í¬ êµì²´"
            ln -sfn $NEW_RELEASE_DIR $CURRENT_LINK
            
            echo "4. ì„œë¹„ìŠ¤ ì¬ì‹œì‘"
            # systemd ì„œë¹„ìŠ¤ íŒŒì¼ì€ ExecStart=$PROJECT_DIR/venv/bin/uvicorn ... $PROJECT_DIR/current/main:app í˜•íƒœì—¬ì•¼ í•¨
            sudo systemctl restart ai-service
            
            echo "5. ìƒíƒœ í™•ì¸"
            sudo systemctl status ai-service --no-pager
            sleep 10

      # 6. Health Check (Port 8000)
      - name: Health Check
        id: healthcheck
        uses: appleboy/ssh-action@v1.0.0
        # continue-on-error: true
        with:
          host: ${{ github.base_ref == 'main' && secrets.PROD_SERVER_HOST || secrets.DEV_SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          port: 22
          script: |
            echo "6. Health Check..."
            MAX_RETRY=10
            RETRY_COUNT=0
            
            while [ $RETRY_COUNT -lt $MAX_RETRY ]; do
              if curl -f -s http://localhost:8000/api/v1/health > /dev/null; then
                echo "Health check passed!"
                exit 0
              fi
              RETRY_COUNT=$((RETRY_COUNT+1))
              sleep 10
            done
            
            echo "Health check failed!"
            # ë¡œê·¸ë¥¼ ì¶œë ¥í•˜ê³  ë¹„ì •ìƒ ì¢…ë£Œ
            journalctl -u ai-service -n 30 --no-pager
            exit 1

      # 7. ì‹œë§¨í‹± ë²„ì €ë‹
      - name: Create Semantic Version Tag
        if: steps.healthcheck.outcome == 'success' && github.event.pull_request.base.ref == 'main'
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          LATEST_TAG=$(git describe --tags --abbrev=0 --match "ai-v*.*.*" 2>/dev/null || echo "ai-v0.0.0")
          VERSION=${LATEST_TAG#ai-v}
          MAJOR=$(echo $VERSION | cut -d. -f1)
          MINOR=$(echo $VERSION | cut -d. -f2)
          PATCH=$(echo $VERSION | cut -d. -f3)
          PATCH=$((PATCH + 1))
          NEW_VERSION="ai-v${MAJOR}.${MINOR}.${PATCH}"
          
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git tag -a $NEW_VERSION -m "AI Release $NEW_VERSION"
          git push origin $NEW_VERSION
          
          echo "DEPLOY_TAG=$NEW_VERSION" >> $GITHUB_ENV

      # 8. ì˜¤ë˜ëœ ë°°í¬ ì •ë¦¬ (í´ë” ì •ë¦¬)
      - name: Cleanup Old Releases
        if: steps.healthcheck.outcome == 'success'
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ github.base_ref == 'main' && secrets.PROD_SERVER_HOST || secrets.DEV_SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          script: |
            set -e
            cd /home/ubuntu/ai/release
            # ë‚ ì§œìˆœ ì •ë ¬ í›„ ìµœì‹  5ê°œ ì œì™¸í•˜ê³  ì‚­ì œ (í´ë” ê¸°ì¤€)
            ls -dt 20* | tail -n +6 | xargs -r rm -rf
            # zip íŒŒì¼ë„ ì •ë¦¬
            ls -t ai-app-*.zip | tail -n +6 | xargs -r rm -v

      # 9. Discord ì„±ê³µ ì•Œë¦¼
      - name: Discord Notification - Success
        if: success()
        env:
          DISCORD_WEBHOOK: ${{ secrets.DISCORD_WEBHOOK_URL }}
          DISCORD_EMBEDS: |
            [{
              "title": "âœ… AI CD ì„±ê³µ", 
              "color": 5763719,
              "fields": [
                {"name": "ğŸ“ Repository", "value": "${{ github.repository }}", "inline": false},
                {"name": "ğŸª„ Merge To", "value": "${{ github.base_ref }}", "inline": true},
                {"name": "ğŸ‘¤ Triggered By", "value": "**${{ github.actor }}**", "inline": true},
                {"name": "ğŸ“ Commit/PR", "value": "${{ github.event.pull_request.title }}", "inline": false},
                {"name": "ğŸ”— Actions Log", "value": "[Link to Action](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})", "inline": true}
              ],
              "footer": {
                "text": "Build #${{ github.run_number }} â€¢ ${{ steps.current-time.outputs.formattedTime }} KST",
              }
            }]
        uses: Ilshidur/action-discord@0.4.0
        with:
          args: 'CD íŒŒì´í”„ë¼ì¸ì´ ì„±ê³µì ìœ¼ë¡œ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤. <@${{ secrets.DISCORD_MENTION_USER_ID_3 }}>'

       # 10. Discord ì‹¤íŒ¨ ì•Œë¦¼
      - name: Discord Notification - Failure
        if: failure()
        env:
          DISCORD_WEBHOOK: ${{ secrets.DISCORD_WEBHOOK_URL }}
          DISCORD_EMBEDS: |
            [{
              "title": "ğŸš¨ AI CD ì‹¤íŒ¨",
              "color": 15548997,
              "fields": [
                {"name": "ğŸ“ Repository", "value": "${{ github.repository }}", "inline": false},
                {"name": "ğŸª„ Merge To", "value": "${{ github.base_ref }}", "inline": true},
                {"name": "ğŸ‘¤ Triggered By", "value": "**${{ github.actor }}**", "inline": true},
                {"name": "ğŸ“ Commit/PR", "value": "${{ github.event.pull_request.title }}", "inline": false},
                {"name": "ğŸ”— Actions Log", "value": "[Link to Action](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})", "inline": true}
              ],
              "footer": {
                "text": "Build #${{ github.run_number }} â€¢ ${{ steps.current-time.outputs.formattedTime }} KST",
              }
            }]
        uses: Ilshidur/action-discord@0.4.0
        with:
          args: 'CD íŒŒì´í”„ë¼ì¸ ì‹¤í–‰ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ë¡œê·¸ë¥¼ í™•ì¸í•´ì£¼ì„¸ìš”. <@${{ secrets.DISCORD_MENTION_USER_ID }}> <@${{ secrets.DISCORD_MENTION_USER_ID_2 }}> <@${{ secrets.DISCORD_MENTION_USER_ID_3 }}>'